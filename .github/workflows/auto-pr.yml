name: Auto Create Pull Request

on:
  push:
    branches:
      - 'draft/**'
      - 'fix/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          # Verifica se j√° existe uma PR para essa branch
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get branch type and create PR title
        id: pr-details
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          
          if [[ $BRANCH_NAME == draft/* ]]; then
            PR_TITLE="[DRAFT] $(echo $BRANCH_NAME | sed 's/draft\///' | sed 's/-/ /g' | sed 's/\b\w/\u&/g')"
            PR_LABELS="draft,needs-review"
            
            echo "üöß **Esta √© uma PR de rascunho de artigo (draft)**" > pr_body.txt
            echo "" >> pr_body.txt
            echo "Esta PR foi criada automaticamente para a branch \`$BRANCH_NAME\`." >> pr_body.txt
            echo "" >> pr_body.txt
            echo "## Descri√ß√£o" >> pr_body.txt
            echo "Esta PR cont√©m um artigo em desenvolvimento. Por favor, revise o conte√∫do e forne√ßa feedback." >> pr_body.txt
            echo "" >> pr_body.txt
            echo "## Observa√ß√µes" >> pr_body.txt
            echo "- Esta PR ser√° marcada como draft at√© estar pronta para publica√ß√£o" >> pr_body.txt
            echo "- Adicione coment√°rios e sugest√µes de melhoria" >> pr_body.txt
            
          elif [[ $BRANCH_NAME == fix/* ]]; then
            PR_TITLE="[FIX] $(echo $BRANCH_NAME | sed 's/fix\///' | sed 's/-/ /g' | sed 's/\b\w/\u&/g')"
            PR_LABELS="bug,fix,needs-review"
            
            echo "üöß  **Esta √© uma PR de corre√ß√£o de artigo (fix)**" > pr_body.txt
            echo "" >> pr_body.txt
            echo "Esta PR foi criada automaticamente para a branch \`$BRANCH_NAME\`." >> pr_body.txt
            echo "" >> pr_body.txt
            echo "## Descri√ß√£o" >> pr_body.txt
            echo "Esta PR cont√©m corre√ß√µes para o blog. Por favor, revise as altera√ß√µes." >> pr_body.txt
            echo "" >> pr_body.txt
            echo "## Tipo de corre√ß√£o" >> pr_body.txt
            echo "- [ ] Corre√ß√£o de bug" >> pr_body.txt
            echo "- [ ] Corre√ß√£o de typo" >> pr_body.txt
            echo "- [ ] Corre√ß√£o de link quebrado" >> pr_body.txt
            echo "- [ ] Corre√ß√£o de formata√ß√£o" >> pr_body.txt
            echo "- [ ] Corre√ß√£o de metadados" >> pr_body.txt
            echo "- [ ] Outro: ___________" >> pr_body.txt
            echo "" >> pr_body.txt
            echo "## Observa√ß√µes" >> pr_body.txt
            echo "- Descreva brevemente o que foi corrigido" >> pr_body.txt
            echo "- Adicione screenshots se relevante" >> pr_body.txt
          fi
          
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_labels=$PR_LABELS" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          # Determina se a PR deve ser criada como draft
          DRAFT_FLAG=""
          if [[ "${{ steps.check-pr.outputs.branch_name }}" == draft/* ]]; then
            DRAFT_FLAG="--draft"
          fi
          
          gh pr create \
            --title "${{ steps.pr-details.outputs.pr_title }}" \
            --body-file pr_body.txt \
            --base main \
            --head "${{ steps.check-pr.outputs.branch_name }}" \
            --label "${{ steps.pr-details.outputs.pr_labels }}" \
            $DRAFT_FLAG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on existing PR
        if: steps.check-pr.outputs.pr_exists != '0'
        run: |
          echo "‚úÖ Uma Pull Request j√° existe para a branch ${{ steps.check-pr.outputs.branch_name }}"
          
          # Adiciona um coment√°rio na PR existente sobre o novo push
          gh pr comment "${{ steps.check-pr.outputs.branch_name }}" \
            --body "üîÑ **Novos commits detectados** - Novos commits foram adicionados a esta branch. A PR foi automaticamente atualizada. - ‚è∞ Atualizado em: $(date -u '+%Y-%m-%d %H:%M:%S UTC') - üìù Commit: \`${GITHUB_SHA:0:7}\`"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}