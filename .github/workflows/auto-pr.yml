name: Auto Create Pull Request

on:
  push:
    branches:
      - 'draft/**'
      - 'fix/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          # Verifica se já existe uma PR para essa branch
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get branch type and create PR title
        id: pr-details
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          
          if [[ $BRANCH_NAME == draft/* ]]; then
            PR_TITLE="[DRAFT] $(echo $BRANCH_NAME)"
            PR_LABELS="draft,needs-review"
            cat > pr_body.txt << 'EOF'
          🚧 **Esta é uma PR de rascunho (draft)**

          Esta PR foi criada automaticamente para a branch `BRANCH_NAME_PLACEHOLDER`.

          ## Descrição
          Esta PR contém um artigo em desenvolvimento. Por favor, revise o conteúdo e forneça feedback.

          ## Checklist
          - [ ] Conteúdo revisado
          - [ ] Gramática e ortografia verificadas
          - [ ] Links funcionando
          - [ ] Imagens otimizadas
          - [ ] Metadados corretos

          Esta PR foi criada automaticamente para a branch `BRANCH_NAME_PLACEHOLDER`.

          ## Descrição
          Esta PR contém correções para o blog. Por favor, revise as alterações.

          ## Tipo de correção
          - [ ] Correção de bug
          - [ ] Correção de typo
          - [ ] Correção de link quebrado
          - [ ] Correção de formatação
          - [ ] Correção de metadados
          - [ ] Outro: ___________

          ## Checklist
          - [ ] Alterações testadas localmente
          - [ ] Não quebra funcionalidades existentes
          - [ ] Documentação atualizada (se necessário)

        
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          # Determina se a PR deve ser criada como draft
          DRAFT_FLAG=""
          if [[ "${{ steps.check-pr.outputs.branch_name }}" == draft/* ]]; then
            DRAFT_FLAG="--draft"
          fi
          
          gh pr create \
            --title "${{ steps.pr-details.outputs.pr_title }}" \
            --body-file pr_body.txt \
            --base main \
            --head "${{ steps.check-pr.outputs.branch_name }}" \
            --label "${{ steps.pr-details.outputs.pr_labels }}" \
            $DRAFT_FLAG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on existing PR
        if: steps.check-pr.outputs.pr_exists != '0'
        run: |
          echo "✅ Uma Pull Request já existe para a branch ${{ steps.check-pr.outputs.branch_name }}"
          
          # Adiciona um comentário na PR existente sobre o novo push
          gh pr comment "${{ steps.check-pr.outputs.branch_name }}" \
            --body "🔄 **Novos commits detectados**

          Novos commits foram adicionados a esta branch. A PR foi automaticamente atualizada.

          ⏰ Atualizado em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          📝 Commit: \`${GITHUB_SHA:0:7}\`"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}