name: Auto Create Pull Request

on:
  push:
    branches:
      - 'draft/**'
      - 'fix/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"
          
          # Verifica se jÃ¡ existe uma PR para essa branch
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get branch type and create PR title
        id: pr-details
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch_name }}"
          
          if [[ $BRANCH_NAME == draft/* ]]; then
            PR_TITLE="[DRAFT] $(echo $BRANCH_NAME)"
            PR_LABELS="draft,needs-review"
            cat > pr_body.txt << 'EOF'
          ðŸš§ **Esta Ã© uma PR de rascunho (draft)**

          Esta PR foi criada automaticamente para a branch `BRANCH_NAME_PLACEHOLDER`.

          ## DescriÃ§Ã£o
          Esta PR contÃ©m um artigo em desenvolvimento. Por favor, revise o conteÃºdo e forneÃ§a feedback.

          ## Checklist
          - [ ] ConteÃºdo revisado
          - [ ] GramÃ¡tica e ortografia verificadas
          - [ ] Links funcionando
          - [ ] Imagens otimizadas
          - [ ] Metadados corretos

          Esta PR foi criada automaticamente para a branch `BRANCH_NAME_PLACEHOLDER`.

          ## DescriÃ§Ã£o
          Esta PR contÃ©m correÃ§Ãµes para o blog. Por favor, revise as alteraÃ§Ãµes.

          ## Tipo de correÃ§Ã£o
          - [ ] CorreÃ§Ã£o de bug
          - [ ] CorreÃ§Ã£o de typo
          - [ ] CorreÃ§Ã£o de link quebrado
          - [ ] CorreÃ§Ã£o de formataÃ§Ã£o
          - [ ] CorreÃ§Ã£o de metadados
          - [ ] Outro: ___________

          ## Checklist
          - [ ] AlteraÃ§Ãµes testadas localmente
          - [ ] NÃ£o quebra funcionalidades existentes
          - [ ] DocumentaÃ§Ã£o atualizada (se necessÃ¡rio)

        
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          # Determina se a PR deve ser criada como draft
          DRAFT_FLAG=""
          if [[ "${{ steps.check-pr.outputs.branch_name }}" == draft/* ]]; then
            DRAFT_FLAG="--draft"
          fi
          
          gh pr create \
            --title "${{ steps.pr-details.outputs.pr_title }}" \
            --body-file pr_body.txt \
            --base main \
            --head "${{ steps.check-pr.outputs.branch_name }}" \
            --label "${{ steps.pr-details.outputs.pr_labels }}" \
            $DRAFT_FLAG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on existing PR
        if: steps.check-pr.outputs.pr_exists != '0'
        run: |
          echo "âœ… Uma Pull Request jÃ¡ existe para a branch ${{ steps.check-pr.outputs.branch_name }}"
          
          # Adiciona um comentÃ¡rio na PR existente sobre o novo push
          gh pr comment "${{ steps.check-pr.outputs.branch_name }}" \
            --body "ðŸ”„ **Novos commits detectados**

          Novos commits foram adicionados a esta branch. A PR foi automaticamente atualizada.

          â° Atualizado em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ðŸ“ Commit: \`${GITHUB_SHA:0:7}\`"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}