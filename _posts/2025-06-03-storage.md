---
layout: post
image: assets/images/system-design/capa-resiliencia.png
author: matheus
featured: false
published: true
categories: [ system-design, engineering, cloud ]
title: System Design - Storage, RAID e Sistemas de Arquivos
---

# Definindo Storage e Armazenamento 

O termo **Storage,** ou armazenamento, refere-se a **persistência de dados** de forma organizada e escalável, de forma que possam ser recuperados e acessados de forma segura e performatica. Dentro de um contexto técnico, o armazenamento pode ocorrer em diversos dispositivos físicos,  como discos rígidos tradicionais como os HDDs, unidades de estado sólido, conhecidos como SSDs e sistemas de armazenamento de rede como as soluções de NFS.

Dentro da arquitetura de sistemas, as preocupações com Storage vão além da capacidade de armazenar dados por longos períodos de tempo, pois também incluem trade-offs e decisões chaves estratégicas sobre desempenho, segurança, latência e escalabilidade. Dentro das inúmeras opções de storage que temos acesso em ambientes modernos, precisamos considerar opções que variam suas ponderações entre Persistência (capacidade de manter dados intactos, mesmo após falhas de hardware), Capacidade de expansão (facilidade de aumentar e diminuir partições de armazenamento sem interrupções de serviços e montagens), Redundância de recuperação (estratégias para evitar perda de dados e garantir a recuperação rápida dos dados em caso de falhas de software e hardware), Desempenho e IOPs (capacidade do storage em questão de atender demandas específicas em termos de performance e latência das operações de escrita e leitura dos dados. 

Quanto olhamos com a ótica de sistemas distribuidos, precisamos buscar abordagens onde os dados são armazenados em diversos pontos e são gerenciados de forma descentralizada e replicada entre diversos nodes em diversos servidores, evitando ao máximo o forte acoplamento em um unico host. Em sistemas modernos, as opções que precisam ser consideradas devem fazer uso intensivo de conceitos de  sharding, replicação, resiliência e disponibilidade sem perdas significativas de performance e segurança com opções que vamos abordar ao decorrer do texto.

<br>

# Dimensões em Storage 

Antes de considerarmos os conceitos e estratégias importantes dentro das disciplinas de storage e armazenamento, precisamos entender alguns conceitos que servem de base para avaliar essas arquiteturas e dimensionar o seu funcionamento. Dentro de Storage temos algumas métricas que podem nos ajudar a levantar requisitos e sugerir soluções performáticas na medida que a solução necessita, sem investimentos desnecessários, superdimensionamento ou perdas de performance e disponibilidade. Veremos as principais métricas a seguir. 

## Throughput em Storage

O **Throughput**, [como já vimos anteriormente](/performance-capacidade-escalabilidade/), é o **"número de operações que um sistema consegue realizar dentro de um determinado período de tempo"**, um contador sobre uma unidade de tempo. Em storage representa a **quantidade total de dados que estão sendo transferidos para a unidade de armazenamento dentro de um período**, geralmente sendo descrito como **megabytes por segundo (MB/s)** ou **Gigabytes por segundo (GB/s)**. Discos que possuam capacidade de throughput alta podem ser utilizados para sistemas com volumes massivos de dados com grande quantidade de leitura e escrita, possibilitando que o mesmo consiga **processar grandes quantidade de solicitações sem enfileiramento ou latência adicional**. 

## Bandwidth em Storage

O Bandwidth, ou Largura de Banda, representa no geral a quantidade máxima de dados que um canal de comunicação pode trafegar entre um ou mais componentes. Dentro de storage, ele representa o teto de throughput que podemos atingir entre as operações de leitura e escrita, sendo medido da mesma forma que o throughput atual, **megabytes por segundo (MB/s)** ou **Gigabytes por segundo (GB/s)**.

## I/O e IOPS em Storage

O I/O ou Input/Output representa de forma isolada **uma operação de escrita e leitura que esteja sendo realizada entre um sistema e o volume de armazenamento que o mesmo tenha acesso**. Todas as vezes em que um sistema precisa **persistir arquivos ou linhas de dados para serem tratados em disco, isso caracteriza uma operação de Input**. Cada vez que esse sistema precisa **recuperar dados no storage para processar ou exibir, o mesmo realiza uma operação de Output**.


Para quantificar a capacidade e desemprenho dessas operações, utilizamos a medida de **IOPS**, ou **Input/Output Operations Per Second**, cuja qual representa o **número dessas solicitações de escrita e leitura que estão sendo executadas dentro de um segundo**. Os volumes de armazenamento possuem essa descrição da quantidade maxima de IOPS que o mesmo consiga suportar, e recomanda-se metrificar e observar esse volume atual dessas operações para encontrarmos pontos de throttling, saturação ou se o sistema está proximo, ou excedendo o volume de IOPs suportado para realizarmos dimensionamento adequado. 


# Tipos de Storage

<br>

## DAS - Direct-Attached Storage 

Os DAS, ou Direct-Attached Storages, são o modelo mais tradicional de armazenamento, poins são dispositivos e volumes montados diretamente num servidor através de interfaces SATA, USB ou NVMe. Essa modalidade é uma das mais simples, utilizado onde o desempenho e acesso direto são critérios de muita importância na solução. 

Nesse modelo os discos são alocados diretamente no host que será usado, sem latência adicional vinda por intermediações de dispositivos de rede ou troca de protocolos complexos, sendo uma solução inteligente para aplicações e componentes que são sensíveis a acessos frequentes e intensas no filesystem. 

Apesar das altas vantagens de latência e performance, a arquitetura DAS possui conhecidas dificuldades de escalabilidade horizontal, pois normalmente não possuem suporte para montagem em multiplos servidores e necessitam adições físicas de novos volumes para expandir a capacidade, e muitas vezes necessitando da migração manual dos dados, dificultando a operação e tendo claras limitações de tamanho e custo.

## NAS - Networking Attached Storage

Ao contrário da arquitetura DAS, o NAS, ou Network Attached Storage, se refere a dispositivos ou sistemas que disponibilizam seus dados diretamente conectados a rede, permitindo assim que multiplos clientes se conectem ao mesmo volume e acessem e modifiquem os mesmos dados de forma simultânea  com o uso de protocolos de rede como o NFS (Networking File System) e SMB (Server Message Block). Um NAS pode ser implementado desde em redes domésticas, sistemas de compartilhamento de diretórios corporativos até volumes de aplicações produtivas. Em resumo, o NAS é conhecido pela facilidade de implementação, gerenciamento centralizado e facilidade de acesso aos dados. 

Também ao contrário dos DAS, o desempenho e performance das implementações de NAS são limitadas a latência de rede e largura de banda disponível, ainda mais se houver demandas previstas de leitura e escrita de forma intensivas.

## Object Storage

Quando levamos em conta a utilização de Nuvens Públicas, somos apresentados com maior frequência as Object Storages. O Object Storage, ou Armazenamento de Objetvos, é uma abordagem altamente escalável, e muitas vezes implementadas com API's abertas e escalávels que nos permitem armazenas altas quantidades de dados de forma totalmente desacoplada da aplicação. 

Quando comparados a modelos tradicionais que organizam dados em hierarquias de diretórios no sistema de arquivos, o Object Storage trata os dados de forma individual. Cada objeto possui seu conteúdo mas também uma série de metadados que permitem serem organizados, recuperados e manipulados através de API's e comandos claros através dos identificadores únicos de cada objeto. 

Tarefas de alta demanda de gestão de arquivos como replicação, particionamento, backups e gestão de ciclo de vida do dado são realizados de forma transparente, aumentando de forma exponencial aspectos de escalabilidade, durabilidade e disponibilidade.  Exemplos práticos muito utilizados de armazenamento de objetos são o Amazon S3, Azure Blob Storage, Google Cloud Storage e soluções open-source como MinIO e Ceph.

Os Object Storage possuem limitações similares aos NAS, com a excessão de que as operações de leitura e escrita do ponto de vista da aplicação não seja realizada de forma local e sim por intermediações de cliente e servidor do storage, utilizando o mínimo possível de operações de I/O do disco de cada aplicação, tornando o mesmo ideal para arquiteturas cloud native altamente sensíveis a escalabilidade horizontal.

<br>

# RAID - Redundant Array of Independent Disks


<br>

## RAID 0 (Striping)

O RAID 0 aplica uma arquitetura denominada como “stripping", onde os dados são distribuídos igualmente entre dois ou mais discos ou volumes. A principal característica do RAID 0 é a extrema otimização em termos de escrita e leitura, já que ambos ocorrem paralelamente entre todos os discos envolvidos, somando toda a taxa de transferência de todos os volumes. Em contra partida, se um único disco do RAID falhar, todos os dados são perdidos, o que torna o mesmo inadequado para cenários onde temos dados críticos de longa duração. 

![Raid 0](/assets/images/system-design/raid-0.drawio.png)

A extensão do RAID 0 é contínua e expansível para o número de volumes anexados a ele. Por exemplo, se temos 4 discos de 10 Terabytes cada, significa que o volume total do nosso RAID será de 10 Teras de armazenamento que será distribuído igualmente entre todos os participantes do volume. 

![Raid 0 - Volumes](/assets/images/system-design/raid-0-volumes.drawio.png)

<br>

## RAID 1 (Mirroring)

Enquanto o RAID 0 fica em diminuição de latência e performance aos custos de disponibilidade, o RAID 1 aplica o conceito de Mirroring, ou Espelhamento, onde cada disco participante possui um espelho exato de todos os seus dados em outro disco. Essa replicação é realizada de forma contínua para fornecer proteção e disponibilidade em caso de falha de algum dos volumes. Caso um dos discos apresente problemas, o outro assume imediatamente sem nenhum tipo de interrupção ou perda.

![Raid 1](/assets/images/system-design/raid-1.drawio.png)

O RAID 1 tem tradeoffs conhecidos de performance, mas em contraponto oferece maior confiabilidade, sendo o ideal para volumes que comportem sistemas operacionais, bancos de dados ou outros tipos de aplicações criticas, já que o mesmo dado é replicado e armazenado mais de uma vez. 

<br>

## RAID 5 (Striping com Paridade Distribuída)

O RAID 5 oferece uma melhor solução contra os trade-offs do RAID 0 e RAID 1, dando um melhor desempenho de escrita e leitura sem sacrificar disponibilidade e segurança. Assim como o RAID 0, ele atua realizando suas escritas de forma distribuida entre os volumes, mas em compensação mantém metadados de paridade distribuídos entre todos os volumes para que em caso de falha de uma parcela dos mesmos, a informação possa ser rapidamente reconstituída e restaurada. 

![Raid 5](/assets/images/system-design/raid-5.drawio.png)

Importante ressaltar que a construção de storages em RAID 5 necessita de no mínimo 3 discos, e seu volume total se constitui na soma de todos os volumes, menos a capacidade de um disco, pois a proporcionalidade do mesmo é utilizado para armazenamento das referencias de paridade, mesmo que a mesma seja distribuída entre todos os discos. 

Por exemplo, se seu storage tiver 5 discos de 10 terabytes, a capacidade total será de 40 Teras. Isso também significa que o mesmo só pode tolerar a perda de uma unidade de disco por vez. Em caso de perda de um disco, a paridade pode ser utilizada para reconstituir os dados, porem a performance é reduzida até a reconstrução do dado e a reposição do disco.

![Raid 5 - Volume](/assets/images/system-design/raid-5-volume.drawio.png)


<br>

## RAID 6 (Striping com Dupla Paridade)

O RAID 6 trabalha com distribuição de paridade semelhante ao RAID 5, porém possui uma camada adicional de paridade distribuida. Essa paridade permite que ao invés de um, dois discos possam falhar simultaneamente sem perda de dados. Os critérios de desempenho são razoavelmente reduzidos no RAID 6 devido a essa camada extra de disponibilidade, porém é extremamente recomendado para sistemas críticos e com grande volume de dados a longo prazo. 

![Raid 6](/assets/images/system-design/raid-6.drawio.png)

O calculo total do storage funciona de forma parecida com o RAID 5 também, porém o RAID 6 precisa de ao invés de um, dois volumes adicionais, e o seu volume total se constitui da soma de todos os volumes, menos a capacidade de dois discos. 

Seguindo o mesmo exemplo, se o storage tiver 5 discos de 10 terabytes, a capacidade total será de 30 teras, podendo tolerar a falha de até 2 volumes sem perdas ou corrupção de dados.

<br>

## RAID 10 (Combinação de RAID 1 com RAID 0)

O RAID 10, ou RAID 1+0, é uma combinação dos algoritmos de mirroring do RAID 1 e a arquitetura de stripping do RAID 0. Primeiramente, os dados são distribuídos em blocos entre vários discos como realizado pelo RAID 0 e em seguida os mesmos são replicados para o disco espelho, tal qual proposto pelo RAID 1.

Esse método acrescenta uma alta disponibilidade e sendo resiliente contra falhas simultâneas de disco, desde que não sejam ambos da mesma faixa de espelhamento. A desvantagem principal, é o alto custo, visto que a capacidade total é reduzida pela metade, pois 50% dos volumes são utilizados para redundância. 

![Raid 10](/assets/images/system-design/raid-10.drawio.png)

O RAID 10 é extremamente aconselhavel para sistemas financeiros, hospitalares e cargas transacionais críticas.